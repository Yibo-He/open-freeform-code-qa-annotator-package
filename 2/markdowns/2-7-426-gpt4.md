
# Post \#62967224 [Link](https://stackoverflow.com/questions/62967224/)

## How to solve "CSRF Token Mismatch" in Laravel

**Vote**: 8 (428/702) **Views**: 17489 (326/702) 

**Internal ID** \#2-7-426

Created at 2020-07-18 10:03:06

Tags: `php` `laravel` `csrf`

----------

#### Metadata:

Area: `Back-end`

Language: `php` (full parsed tag list: `php`)

----------

**Notepad**


----------

I am working on a laravel application. Upon hosting it on my domain, I am running into a "CSRF token mismatch" error. Locally, the application is working fine because I have included the csrf token in the header as shown in the documentation. Therefore, the csrf token is being generated successfully and being included in the header of requests. On doing some debugging, I changed the `SESSION_DRIVER` in env file to `file` so that I can see the sessions. I realized that multiple sessions are being generated for one user. The `SESSION_LIFETIME` is set to `120`, which I believe is okay. In looking at the tokens in the sessions stored in `storage/framework/sessions`, none contains the token that is generated by the browser. What could be the issue? Remember that it is working fine locally. What configurations on the host domain could be affecting the sessions of the application.


----------
        
## GPT4 Attempt \#0

The "CSRF token mismatch" error is often caused by issues related to sessions. Since you've already checked the session files and found that multiple sessions are being generated for one user, it's likely that the issue is related to how sessions are being handled on your server.

Here are a few things you can check:

1. **Domain Configuration**: Make sure that your domain is correctly configured in your `.env` file. The `APP_URL` should match the domain you're using. If it doesn't, Laravel might not be able to correctly link the session to the user.

2. **Cookie Domain**: If your application is served from a subdomain, you might need to specify the parent domain in the `SESSION_DOMAIN` variable in your `.env` file. For example, if your application is served from `app.example.com`, you should set `SESSION_DOMAIN=.example.com`.

3. **Session Cookie Path**: Check the `SESSION_COOKIE_PATH` in your `.env` file. It should be set to `/` to make the session cookie available to all routes in your application.

4. **HTTPS**: If your application is served over HTTPS, make sure that the `SESSION_SECURE_COOKIE` is set to `true` in your `.env` file. This ensures that the session cookie is only sent over secure connections.

5. **Server Configuration**: Some server configurations might interfere with how sessions are handled. For example, if you're using a load balancer without sticky sessions, requests from the same user might be sent to different servers, causing multiple sessions to be created. Check your server configuration to make sure it's compatible with Laravel's session handling.

6. **Cache Configuration**: If you're using a cache driver like Redis or Memcached for sessions, make sure it's correctly configured and working as expected. You might need to clear the cache to resolve the issue.

7. **Session Driver**: Try changing the session driver to `database` or `cookie` to see if the issue persists. This can help you determine if the issue is related to the session driver you're currently using.

Remember to clear your config cache (`php artisan config:cache`) after making changes to your `.env` file.

--------

## GPT4 Attempt \#1

The issue you're experiencing could be due to several reasons. Here are some possible causes and solutions:

1. **Domain Configuration**: Ensure that your domain is correctly configured. If you're using `www` in your URL, make sure that your `SESSION_DOMAIN` in your `.env` file is set to `.yourdomain.com` (note the leading dot). This allows sessions to be shared across subdomains.

2. **Cookie Settings**: Check your cookie settings. In your `config/session.php`, make sure the `secure` option is set to `true` if you are using HTTPS, and `false` if not. Also, ensure that the `same_site` option is set to `null`, `lax`, or `strict`, depending on your needs.

3. **Server Timezone**: Ensure that your server's timezone matches the timezone set in your `config/app.php` file. A mismatch could cause the session to expire prematurely.

4. **File Permissions**: Check the permissions of the `storage/framework/sessions` directory. Laravel needs to be able to read and write to this directory. The permissions should be set to `755` or `775`.

5. **Cache**: Try clearing your application cache by running `php artisan cache:clear` and `php artisan config:clear` commands.

6. **Session Driver**: If you're using a driver other than `file` for sessions (like `database`, `redis`, etc.), ensure that it's correctly configured and working as expected.

7. **Middleware**: Ensure that the `\App\Http\Middleware\VerifyCsrfToken::class` middleware is included in your `app/Http/Kernel.php` file.

Remember to restart your server after making these changes to ensure they take effect. If none of these solutions work, it might be a good idea to contact your hosting provider and ask them if they have any special configurations that could be affecting your sessions.

--------

## GPT4 Attempt \#2

The "CSRF token mismatch" error can be caused by several reasons. Here are a few things you can check:

1. **Domain Configuration**: Make sure your domain is correctly configured. If you have a www version and a non-www version of your domain, Laravel may treat them as separate sessions. Ensure you are redirecting to one version.

2. **Cookie Configuration**: Check your `config/session.php` file. The `domain` parameter in this file should match the domain of your application. If it's set to `null`, Laravel will try to guess the domain. You can try setting it to your domain.

3. **Secure Cookies**: If your `config/session.php` file has `secure` set to `true`, it means that Laravel will only send the cookie over a HTTPS connection. If your domain is not using HTTPS, this could be causing the issue. You can set it to `false` or `env('SESSION_SECURE_COOKIE', false)` to allow sending cookies over HTTP.

4. **SameSite Cookies**: The `same_site` parameter in `config/session.php` file determines whether the browser should send a cookie along with cross-site requests. The possible values are `lax` (default), `strict`, `none`, or `null`. If you're making requests to different sites, you might need to adjust this setting.

5. **Session Driver**: You mentioned that you changed the `SESSION_DRIVER` to `file`. Make sure the `storage/framework/sessions` directory is writable by the server.

6. **Clearing Cookies and Cache**: Sometimes, old cookies can cause issues. Try clearing your browser's cookies and cache.

7. **Middleware**: Ensure that the `VerifyCsrfToken` middleware is applied to the routes where you're having this issue.

8. **Hosting Provider Settings**: Some hosting providers have specific settings that might interfere with session handling. Check with your hosting provider if they have any special requirements for session handling.

Remember to clear your config cache (`php artisan config:cache`) after making changes to the configuration files.

--------
